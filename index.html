<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory Management</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2b; --muted:#1a2540; --text:#e6eefc; --dim:#9fb3d1;
      --primary:#3b82f6; --danger:#ef4444; --ring:#60a5fa; --ok:#10b981;
    }
    html,body{height:100%;}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text);}
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px;}
    h1{font-size:22px; margin:0; letter-spacing:.3px}
    .controls{display:flex; flex-wrap:wrap; gap:8px}

    .btn{appearance:none; border:1px solid transparent; background:#1f2a44; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn:hover{filter:brightness(1.08)}
    .btn:focus{outline:none; box-shadow:0 0 0 2px var(--ring)}
    .btn-primary{background:var(--primary)}
    .btn-danger{background:var(--danger)}
    .btn-secondary{background:var(--muted)}
    .btn-ghost{background:transparent; border:1px solid var(--muted)}

    .tabs{display:flex; gap:6px; margin-top:16px}
    .tab{padding:8px 12px; border-radius:10px; background:var(--card); cursor:pointer; font-weight:700; color:var(--dim)}
    .tab.active{background:var(--muted); color:var(--text)}

    .card{background:var(--card); border:1px solid #1d2945; border-radius:16px; padding:12px}
    .row{display:flex; gap:8px}
    label{display:block; font-size:12px; color:var(--dim); margin-bottom:4px}
    input, select, textarea{width:100%; box-sizing:border-box; background:#0e1627; color:var(--text); border:1px solid #203055; border-radius:10px; padding:8px}

    table{width:100%; border-collapse:collapse}
    th,td{padding:8px; text-align:left}
    thead th{font-size:12px; color:var(--dim); border-bottom:2px solid #1f2a44}
    tbody tr{border-top:1px solid #1f2a44}

    .small{font-size:12px; color:var(--dim)}

    /* Modals */
    .modal-backdrop{position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center; z-index:50}
    .modal{width:min(980px, 96vw); max-height:90vh; overflow:auto; background:var(--card); border:1px solid #263659; border-radius:16px; padding:12px}
    .modal-header{display:flex; align-items:center; justify-content:space-between; gap:8px}

    .pill{display:inline-flex; gap:6px; align-items:center; background:#0f1a30; border:1px solid #203055; padding:4px 8px; border-radius:999px; font-size:12px}
    /* Apply width to all model columns */
    .col-model {
      min-width: 150px;
      white-space: nowrap;
    }


    .status{position:fixed; right:12px; bottom:12px; background:var(--card); border:1px solid #24406f; border-left:4px solid var(--ok); padding:10px 12px; border-radius:12px; display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Inventory Management</h1>
      <div class="controls">
        <button class="btn btn-primary" onclick="showAddProduct()">+ Add / Edit Product</button>
        <button class="btn btn-secondary" onclick="openBulkInModal()">‚ûï Bulk In Stock</button>
        <button class="btn btn-danger" onclick="openBulkOutModal()">‚ûñ Bulk Out Stock</button>
        <button class="btn btn-secondary" onclick="showPOOverview()">üì¶ PO Overview</button>
        <button class="btn btn-secondary" onclick="showProjectsOverview()">üìÅ Projects Overview</button>
        <button class="btn btn-secondary" onclick="showTotalStockList()">üìä Total Stock</button>
        <button class="btn btn-ghost" onclick="showAdmin()">üîß Admin</button>
        <button class="btn btn-secondary" onclick="openRemarkSearch()">üîç Search by ProjectCode</button>
      </div>
    </header>

    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="stock" onclick="switchTab('stock')">Stock</div>
      <div class="tab" data-tab="projects" onclick="switchTab('projects')">Projects</div>
      <div class="tab" data-tab="transactions" onclick="switchTab('transactions')">Transactions</div>
    </div>

    <!-- STOCK TAB -->
    <div id="tab-stock" class="card" style="margin-top:12px;">
      <div class="row" style="flex-wrap:wrap; margin-bottom:8px;">
        <div style="flex:1 1 160px;">
          <label>Category</label>
          <select id="filter-category" onchange="updateAllProductsView(true,1)">
            <option value="">All</option>
          </select>
        </div>
        <div style="flex:2 1 240px;">
          <label>Search (model / barcode)</label>
          <input id="filter-search" placeholder="Type to search..." oninput="updateAllProductsView(true,1)" />
        </div>
        <div style="flex:1 1 120px;">
          <label>&nbsp;</label>
          <button class="btn" onclick="exportProductsCSV()">üì§ Export CSV</button>
        </div>
      </div>
      <div id="products-list">Loading...</div>
    </div>

    <!-- PROJECTS TAB -->
    <div id="tab-projects" class="card" style="margin-top:12px; display:none;">
      <div class="row" style="flex-wrap:wrap; margin-bottom:8px;">
        <div style="flex:2 1 240px;">
          <label>Search (model / barcode)</label>
          <input id="project-filter-search" placeholder="Type to search..." oninput="renderProjectsTab()" />
        </div>
        <div style="flex:2 1 260px;">
          <label>Project name</label>
          <input id="project-name" placeholder="Enter project name" />
        </div>
        <div style="flex:1 1 180px;">
          <label>Action</label>
          <select id="project-action-select" onchange="updateProjectAction()">
            <option value="add">Add to Project (reserve)</option>
            <option value="removeproject">Remove from Project</option>
            <option value="addstock">Add to Stock</option>
            <option value="removestock">Remove from Stock</option>
          </select>
        </div>
        <div style="flex:1 1 140px;">
          <label>Quantity</label>
          <input type="number" id="project-quantity" min="1" value="1" />
        </div>
        <div style="flex:1 1 160px; display:none;" id="po-number-row">
          <div>
            <label>PO Number</label>
            <input type="text" id="project-po-number" placeholder="Enter PO"/>
          </div>
        </div>
        <div style="flex:1 1 180px; display:none;" id="stock-date-row">
          <div>
            <label>Stock In/Out Date</label>
            <input type="date" id="project-stock-date" />
          </div>
        </div>
        <div style="flex:2 1 260px;">
          <label>Note</label>
          <input id="project-reason" placeholder="Optional reason..." />
        </div>
        <div style="flex:1 1 160px;">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="performProjectAction()">Apply</button>
        </div>
      </div>

      <div class="small" style="margin-bottom:8px;">Tip: Selecting a product below sets the target for the action.</div>
      <div id="project-products-list">Loading...</div>
    </div>

    <!-- TRANSACTIONS TAB -->
    <div id="tab-transactions" class="card" style="margin-top:12px; display:none;">
      <div class="row" style="flex-wrap:wrap; margin-bottom:8px;">
        <div style="flex:1 1 220px;">
          <label>Filter by PO</label>
          <input id="tx-filter-po" placeholder="Type PO number..." oninput="updateTransactionHistory()" />
        </div>
        <div style="flex:1 1 220px;">
          <label>Filter by model</label>
          <input id="tx-filter-model" placeholder="Type model..." oninput="updateTransactionHistory()" />
        </div>
        <div style="flex:1 1 160px;">
          <label>&nbsp;</label>
          <button class="btn" onclick="exportTransactionsCSV()">üì§ Export CSV</button>
        </div>
      </div>
      <div id="transactions-list">Loading...</div>
    </div>
  </div>

  <!-- MODALS -->
  <!-- Add/Edit Product -->
  <div id="product-modal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <h3 id="product-modal-title">Add / Edit Product</h3>
        <div class="row" style="gap:6px">
          <button class="btn btn-secondary" onclick="hideAddProduct()">Close</button>
        </div>
      </div>
      <div class="row" style="flex-wrap:wrap; margin-top:8px;">
        <div style="flex:1 1 220px;">
          <label>Model Number</label>
          <input id="p-model" />
        </div>
        <div style="flex:1 1 180px;">
          <label>Suffix</label>
          <input id="p-suffix" />
        </div>
        <div style="flex:1 1 200px;">
          <label>Category</label>
          <input id="p-category" list="datalist-categories" />
          <datalist id="datalist-categories"></datalist>
        </div>
        <div style="flex:1 1 140px;">
          <label>Quantity (stock)</label>
          <input id="p-qty" type="number" min="0" value="0" />
        </div>
        <div style="flex:1 1 180px;">
          <label>Location</label>
          <input id="p-location" />
        </div>
        <div style="flex:1 1 200px;">
          <label>Barcode</label>
          <input id="p-barcode" />
        </div>
        <div style="flex:1 1 100%">
          <label>Description</label>
          <textarea id="p-desc" rows="2"></textarea>
        </div>
      </div>
      <div class="row" style="gap:8px; margin-top:10px;">
        <button class="btn btn-primary" onclick="saveProduct()">Save</button>
        <button class="btn btn-danger" onclick="deleteProduct()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Bulk In Modal -->
  <div id="bulk-in-modal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <h3>Bulk In Stock</h3>
        <div class="row" style="gap:6px">
          <button class="btn btn-secondary" onclick="closeBulkInModal()">Close</button>
        </div>
      </div>
      <div style="margin-top:12px;">
        <table id="bulk-in-table">
          <thead>
            <tr>
              <th>Category</th><th class = "col-model">Model</th><th>Suffix</th><th>Qty</th><th>Location</th><th>Barcode</th><th>ProjectCode</th><th>PO Number</th><th>Date</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-secondary" onclick="addBulkRow('in')">+ Add Row</button>
          <button class="btn" onclick="exportBulkTable('in')">üì§ Export to Excel</button>
          <button class="btn btn-primary" onclick="saveBulkProducts('in')">Save All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Out Modal -->
  <div id="bulk-out-modal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <h3>Bulk Out Stock</h3>
        <div class="row" style="gap:6px">
          <button class="btn btn-secondary" onclick="closeBulkOutModal()">Close</button>
        </div>
      </div>
      <div style="margin-top:12px;">
        <table id="bulk-out-table">
          <thead>
            <tr>
              <th>Category</th><th class = "col-model">Model</th><th>Suffix</th><th>Qty</th><th>Location</th><th>Barcode</th><th>ProjectCode</th><th>PO Number</th><th>Date</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn btn-secondary" onclick="addBulkRow('out')">+ Add Row</button>
          <button class="btn" onclick="exportBulkTable('out')">üì§ Export to Excel</button>
          <button class="btn btn-danger" onclick="saveBulkProducts('out')">Save All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PO Overview Modal -->
  <div id="po-overview-modal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <h3>üì¶ PO Overview</h3>
        <div class="row" style="gap:6px">
          <button class="btn btn-secondary" onclick="hidePOOverview()">Close</button>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div class="row" style="gap:8px; margin-bottom:8px;">
          <input type="text" id="po-search" placeholder="Search PO number..." oninput="generatePOOverview()" />
          <button class="btn" onclick="exportPOOverviewCSV()">üì§ Export CSV</button>
        </div>
        <div id="po-overview-content">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Projects Overview Modal -->
  <div id="projects-overview-modal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <h3>üìÅ Projects Overview</h3>
        <div class="row" style="gap:6px">
          <button class="btn btn-secondary" onclick="hideProjectsOverview()">Close</button>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <select id="project-overview-select" onchange="generateProjectsOverview()">
            <option value="">-- All Projects --</option>
          </select>
          <button class="btn" onclick="exportSelectedProject()">üì§ Export Selected Project</button>
        </div>
        <div id="projects-overview-content">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Total Stock Modal -->
  <div id="total-stock-modal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <h3>üìä Total Stock List</h3>
        <div class="row" style="gap:6px">
          <button class="btn btn-secondary" onclick="hideTotalStockList()">Close</button>
        </div>
      </div>
      <div style="margin-top:12px;">
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <select id="total-filter-category" onchange="generateTotalStockList(1)">
            <option value="">All Categories</option>
          </select>
          <input type="text" id="total-filter-model" placeholder="Search by model number..." oninput="generateTotalStockList(1)" />
          <button class="btn" onclick="exportTotalStock()">üì§ Export CSV</button>
        </div>
        <div id="total-stock-content">Loading...</div>
      </div>
    </div>
  </div>
  <!-- Remark Search Modal -->
  <div id="remark-search-modal" class="modal-backdrop" style="display:none;">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <h3>Search Transactions by ProjectCode</h3>
        <button class="btn btn-secondary" onclick="closeRemarkSearch()">Close</button>
      </div>
      <div class="modal-body" style="margin-top:12px;">
        <input type="text" id="remark-search-input" placeholder="Enter remark keyword" style="width:100%; margin-bottom:10px;">
        <button class="btn btn-primary" onclick="searchByRemark()">Search</button>

        <table id="remark-search-results" class="table" style="margin-top:12px; width:100%;">
          <thead>
            <tr>
              <th>Date</th>
              <th>Model</th>
              <th>Category</th>
              <th>Qty</th>
              <th>ProjectCode</th>
              <th>Ref</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>




  <!-- Admin Modal -->
  <div id="admin-modal" class="modal-backdrop">
    <div class="modal" role="dialog">
      <div class="modal-header">
        <h3>üîß Admin</h3>
        <div class="row" style="gap:6px">
          <button class="btn btn-secondary" onclick="hideAdmin()">Close</button>
        </div>
      </div>
      <div style="margin-top:12px;" class="row" >
        <div class="card" style="flex:1 1 300px;">
          <h4>Categories</h4>
          <div class="row" style="margin-top:6px;">
            <input id="new-category" placeholder="Add category..." />
            <button class="btn" onclick="addCategory()">Add</button>
          </div>
          <div id="categories-list" style="margin-top:8px;"></div>
        </div>
        <div class="card" style="flex:1 1 300px;">
          <h4>Backup / Restore</h4>
          <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button class="btn" onclick="backupAll()">‚¨áÔ∏è Backup JSON</button>
            <input type="file" id="restore-file" accept="application/json" />
          </div>
          <div class="row" style="gap:8px; margin-top:6px;">
            <button class="btn btn-danger" onclick="restoreAll()">‚¨ÜÔ∏è Restore</button>
          </div>
          <div class="small" style="margin-top:6px;">Backups include products, transactions, project allocations, and settings.</div>
        </div>
        <div class="card" style="flex:1 1 300px; border-top: 2px solid var(--danger);">
          <h4>System Settings</h4>
          <p class="small" style="margin-bottom: 10px;">
            Resetting the connection will remove your Supabase URL and API Key from this browser.
          </p>
          <button class="btn btn-danger" onclick="handleResetConnection()">
            üî¥ Reset API Connection
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="status-toast" class="status"></div>

  <script src="db.js"></script>
  
  <script src = "script.js"></script>
    
</body>
</html>
